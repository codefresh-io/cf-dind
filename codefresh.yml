version: '1.0'
steps:
  build_dind_composition:
    title: "Build inside dind composition"
    type: composition
    add_flow_volume_to_composition: true
    composition:
      version: '2'
      services:
#        dummy:
#          image: alpine:3.5
#          command: "sleep 3600"
        build-dind-daemon:
          image: docker:17.05.0-ce-dind
          command:
            - dockerd
            - -H
            - tcp://0.0.0.0:9998
          ports:
            - 9998:9998
          privileged: true
    composition_candidates:
      builder:
        image: docker:17.05.0-ce
        command:
          - "sh"
          - "-c"
          - |
            sleep 3600
            docker build --build-arg BUILD_DOCKER_HOST=$${BUILD_DOCKER_HOST} -t $${CF_REPO_OWNER}/$${CF_REPO_NAME}:$${CF_BRANCH} .
        # command: "sleep 3600"
        # command: "docker build --build-arg BUILD_DOCKER_HOST=${BUILD_DOCKER_HOST} -t ${CF_REPO_OWNER}/${CF_REPO_NAME}:${CF_BRANCH} . "
        depends_on:
         - build-dind-daemon
        links:
         - build-dind-daemon
        environment:
          BUILD_DOCKER_HOST: 'tcp://build-dind-daemon:9998'
          CF_REPO_OWNER: '${{CF_REPO_OWNER}}'
          CF_REPO_NAME: '${{CF_REPO_NAME}}'
          CF_BRANCH: '${{CF_BRANCH}}'
        privileged: true
        working_dir: '${{CF_VOLUME_PATH}}/cf-dind'
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock:rw
          - '${{CF_VOLUME_NAME}}:/codefresh/volume'

  push_cf_dind:
    type: push
    candidate: '${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}:${{CF_BRANCH}}'
